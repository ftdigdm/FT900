# FT900 Alexa Demo


This PoC application demonstrates using <b>FT900 microcontroller</b> as an <b>Amazon Echo Dot</b> device, where users can issue voice commands to Alexa and hear Alexa’s voice responses generated by Alexa’s complex speech recognition and natural language processing in the cloud. To make this possible, FT900 (Alexa client) communicates with a <b>Raspberry PI 3B+</b> (Alexa gateway), which relays voice requests and voice responses to and from the Alexa cloud. The RPI runs a customized version of Amazon’s official open-source <b>[Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk)</b>, written in C++.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/system_diagram.jpg" width="620"/>

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/alexa_steps.jpg" width="620"/>


This demo is targeted for <b>FTDI/Bridgetek’s</b> smart home devices, <b>PanL Hub</b> and <b>PanL Display</b>. Having <b>[Alexa built-in](https://developer.amazon.com/alexa-voice-service)</b> to <b>PanL Smart Home</b> allow customers to talk directly to Alexa via PanL without needing to buy Amazon Echo devices. PanL Hub, which runs on RPI, acts as the Alexa Gateway while the PanL Display, which runs on FT900 microcontroller, acts as the Alexa Client. Customers will be able to use both PanL Hub and PanL Display to issue voice commands and operations to Alexa.


# FT900-side (Alexa Client)

Below is a block diagram showing the implemented components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram.jpg" width="620"/>

Below is a sequence diagram showing the basic interaction of components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram.jpg" width="620"/>

The main component of the Alexa Demo on the FT900 side is the Alexa AVS library. I created the library to be reusable (for PanL Display) and easy to use (abstract the audio, the SD card and the network communication). The main functions include avs_connect(), avs_record_request(), avs_send_request(), avs_receive_response(), avs_play_response() and avs_disconnect().


### Wakeword Detection

The demo currently does not support Wakeword detection. To trigger FT900 to start recording voice, user has to press down a button. To stop recording, user has to release the button.
This works similar to the remote control for Amazon's Firestick TV.
To support Wakeword detection feature on FT900, external MCUs can be integrated such as [SparkFun's board](https://petewarden.com/2019/03/07/launching-tensorflow-lite-for-microcontrollers/) with Cortex M4 processor with 384KB of RAM and 1MB of Flash storage.


### Audio Processing 

Below is a description of how the audio is processed on FT900.

avs_record_request()
- Audio recorded (from mic): <b>16-bit PCM, 16KHZ, stereo (2-channels)</b>
- Audio saved (to SD card): <b>16-bit PCM, 16KHZ, mono (1-channel)</b>

avs_send_request()
- Audio read (from SD card): <b>16-bit PCM, 16KHZ, mono (1-channel)</b>
- Audio sent (to RPI): <b>8-bit u-law, 16KHZ, mono (1-channel)</b>

avs_recv_response()
- Audio received (from RPI): <b>8-bit u-law, 16KHZ, mono (1-channel)</b>
- Audio saved (to SD card): <b>16-bit PCM, 16KHZ, mono (1-channel)</b>

avs_play_response()
- Audio read (from SD card): <b>16-bit PCM, 16KHZ, mono (1-channel)</b>
- Audio played (to speaker): <b>16-bit PCM, 16KHZ, stereo (2-channels)</b>

Notes
- <b>G711 u-law</b> lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
- Converting stereo data stream to mono data stream is a matter of removing alternating 16-bit WORD.


# RPI-side (Alexa Gateway)

Amazon provides an official [Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk), (written in C++). The version I am using is AVS SDK is v1.11.0, (12-19-2018). Instructions to install the AVS SDK on RPI can also be found on the github link.


Below is a block diagram showing the implemented components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram_rpi.jpg" width="620"/>

Below is a sequence diagram showing the basic interaction of components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram_rpi.jpg" width="620"/>

The primary modifications for the AVS SDK application are contained in PortAudioMicrophoneWrapper class and SpeechSynthesizer classes.
- <b>PortAudioMicrophoneWrapper</b>: PortAudioCallback() contains the data stream for Alexa request
- <b>SpeechSynthesizer</b>: startPlaying() contains the data stream for Alexa response


### Audio Processing 

Below is a description of how the audio is processed on RPI.

avs_request()
- Audio received (from FT900): <b>8-bit u-law, 16KHZ, mono (1-channel)</b>
- Audio sent (to Alexa cloud): <b>16-bit PCM, 16KHZ, mono (1-channel)</b>

avs_response()
- Audio received (from Alexa cloud): <b>MP3</b>
- Audio sent (to FT900): <b>8-bit u-law, 16KHZ, mono (1-channel)</b>

Notes
- <b>G711 u-law</b> lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
- <b>SOX</b> utility is used to convert MP3 data stream to raw PCM16 data stream.


# Action items

Below are the action items for the Alexa Demo.
1. Support for <b>wake-word detection</b> in FT900. Currently, user has to press down a button to start voice recording.
2. Use <b>8KHz instead of 16KHz</b> in FT900 to further reduce audio transmitted size by half. (However, note that RPI will have to convert the 8KHz to 16KHz as Alexa cloud requires 16KHz).
3. Performance/speed optimization
4. Support for <b>alarms or notification-based messages</b>. (Currently, only responses triggered by requests are supported.)
5. Support for <b>very long Alexa responses</b>. (Need to test requests that have very long responses.)
6. Support for <b>queuing Alexa requests from multiple FT900 clients</b>. (Multiple FT900 can simultaneously send requests to RPI. RPI should queue the requests and only issue a request when a response for previous request is processed.)
7. RPI should not play response on its speaker when the request is from FT900.
8. Audio decoding implementation currently uses bash scripts using SOX utility. (Should be replaced with C/C++ code)
9. Upgrade to latest AVS SDK version. Currently using AVS SDK 1.11.0, (12-19-2018). As of today, the latest version is AVS SDK 1.12.0 (02-28-2019).


# References

Below are the essential links to familiarize with Alexa and audio terminologies needed for FT900 Alexa Demo.
1. [Alexa Voice Service (AVS)](https://developer.amazon.com/alexa-voice-service)

      <a href="https://www.youtube.com/watch?v=oTaFX3ZQlnA"
       target="_blank"><img src="https://img.youtube.com/vi/oTaFX3ZQlnA/0.jpg" 
       alt="Alexa Voice Service" width="480" border="10" /></a>

2. [Getting Started with the AVS Device SDK](https://www.youtube.com/watch?v=F5DixCPJYo8&feature=youtu.be)

      <a href="https://www.youtube.com/watch?v=F5DixCPJYo8"
       target="_blank"><img src="https://img.youtube.com/vi/F5DixCPJYo8/0.jpg" 
       alt="Getting Started with the AVS Device SDK" width="480" border="10" /></a>
       
3. [Amazon's Official AVS Device SDK (written in C++)](https://github.com/alexa/avs-device-sdk)
4. [AVS SDK Installation Guide on Raspberry PI](https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script)
5. [SOX Sound Exchange Utility (used for MP3 audio decoding)](http://sox.sourceforge.net)
6. [G711 Audio Companding algorithms (used for u-law audio compression/expanding)](https://en.wikipedia.org/wiki/G.711)

