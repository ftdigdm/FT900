# FT900 Alexa Demo


This PoC application demonstrates using <b>FT900 microcontroller</b> as an <b>Amazon Echo Dot</b> device, where users can issue voice commands to Alexa and hear Alexa’s voice responses generated by Alexa’s complex speech recognition and natural language processing in the cloud. To make this possible, FT900 (Alexa client) communicates with a <b>Raspberry PI 3B+</b> (Alexa gateway), which relays voice requests and voice responses to and from the Alexa cloud. The RPI runs a customized version of Amazon’s official open-source <b>[Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk)</b>, written in C++.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/system_diagram.jpg" width="620"/>

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/alexa_steps.jpg" width="620"/>


This demo is targeted for <b>FTDI/Bridgetek’s</b> smart home devices, <b>PanL Hub</b> and <b>PanL Display</b>. Having <b>[Alexa built-in](https://developer.amazon.com/alexa-voice-service)</b> to <b>PanL Smart Home</b> allow customers to talk directly to Alexa via PanL without needing to buy Amazon Echo devices. Furthermore, customers will have access to the built in capabilities of Alexa (like music playback, timers and alarms, package tracking, movie listings, calendar management, and more) including third-party skills developed using the Alexa Skills Kit. PanL Hub, which runs on RPI, acts as the Alexa Gateway while the PanL Display, which runs on FT900 microcontroller, acts as the Alexa Client. Customers will be able to use both PanL Hub and PanL Display to issue voice commands and operations to Alexa.


# FT900-side (Alexa Client)

Below is a block diagram showing the implemented components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram.jpg" width="620"/>

Below is a sequence diagram showing the basic interaction of components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram.jpg" width="620"/>


### FT900 Alexa AVS library

The main component of the Alexa Demo on the FT900 side is the Alexa AVS library. I created the library to be reusable (for PanL Display) and easy to use (abstract the audio, the SD card and the network communication). The main functions include:

      - avs_connect() - Establish connection with RPI
      - avs_record_request() - Record voice request from microphone and save to SD card
      - avs_send_request() - Read voice request from SD card and send to RPI
      - avs_receive_response() - Receive voice response from RPI and save to SD card
      - avs_play_response() - Play voice response from SD card
      - avs_disconnect() - Closes connection with RPI

### Wakeword Detection

The demo currently does not support Wakeword detection. To trigger FT900 to start recording voice, user has to press down a button. To stop recording, user has to release the button. This works similar to the remote control for Amazon's Firestick TV.

The demo provides two ways to trigger voice recording:

      - UART Mode: Press 't' key on UART terminal
      - GPIO Mode: Press hardware button connected to GPIO 31

To support Wakeword detection feature on FT900, external MCUs can be integrated as slave devices to handle wakeword detection. 
[SparkFun's board](https://petewarden.com/2019/03/07/launching-tensorflow-lite-for-microcontrollers/) is an example board that can be used for wakeword detection.


### Audio Processing 

Below is a description of how the audio is processed on FT900.

      avs_record_request()
      - Audio recorded (from mic): 16-bit PCM, 16KHZ, stereo (2-channels)
      - Audio saved (to SD card): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_send_request()
      - Audio read (from SD card): 16-bit PCM, 16KHZ, mono (1-channel)
      - Audio sent (to RPI): 8-bit u-law, 16KHZ, mono (1-channel)

      avs_recv_response()
      - Audio received (from RPI): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio saved (to SD card): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_play_response()
      - Audio read (from SD card): 16-bit PCM, 16KHZ, mono (1-channel)
      - Audio played (to speaker): 16-bit PCM, 16KHZ, stereo (2-channels)

      Notes
      - G711 u-law lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and                vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
      - Converting stereo data stream to mono data stream is done by averaging the consecutive left and right 16-bits WORDS.


# RPI-side (Alexa Gateway)

Amazon provides an official [Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk), (written in C++). The version I am using is AVS SDK is v1.11.0, (12-19-2018). Instructions to install the AVS SDK on RPI can also be found on the github link.


Below is a block diagram showing the implemented components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram_rpi.jpg" width="620"/>

Below is a sequence diagram showing the basic interaction of components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram_rpi.jpg" width="620"/>


### RPI Alexa AVS SDK modifications

The primary modifications for the AVS SDK application are contained in PortAudioMicrophoneWrapper class and SpeechSynthesizer classes.
 
      - PortAudioMicrophoneWrapper: PortAudioCallback() contains the data stream for Alexa request
      - SpeechSynthesizer: startPlaying() contains the data stream for Alexa response

Below is a list of files modified:

      - SampleApplication.cpp: To initialize FT900ConnectionHandler in separate thread.
      - PortAudioMicrophoneWrapper.cpp: To feed in request data to microphone datastream.
      - SpeechSynthesizer.cpp: To call the callback function when response is received.
      - UserInputManager.cpp: To test pre-recorded audio requests.
      - MediaPlayer.cpp: To fix audiosink issue.
      - DefaultClient.h: To provide access to Speech Synthesizer handle.


After modifications, the total size of the binary executable is 16.2MB.


### Audio Processing 

Below is a description of how the audio is processed on RPI.

      avs_request()
      - Audio received (from FT900): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio sent (to Alexa cloud): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_response()
      - Audio received (from Alexa cloud): MP3
      - Audio sent (to FT900): 8-bit u-law, 16KHZ, mono (1-channel)

      Notes
      - G711 u-law lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and                vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
      - SOX utility is used to convert MP3 data stream to raw PCM16 data stream.


# Setup guide

### Prerequisites:

A. RPI

      1. RPI 3B+ 
      2. Headphone or speaker
      3. USB microphone https://circuit.rocks/usb-mini-microphone.html

B. FT900

      1. FT900 Rev C board
      2. SD card (<= 32gb)
      3. Headphone or speaker
      4. (Optional) Button https://circuit.rocks/button-digital (for GPIO mode)

Note you can issue voice commands to either RPI or FT900.


### RPI setup:

Download the latest [RPI Alexa Gateway](https://github.com/richmondu/FT900/tree/master/Alexa/Amazon%20Alexa%20Gateway) code.
         
A. Install AVS SDK (latest version is AVS SDK 1.12.0 [02-28-2019])

      1. Install the original AVS SDK on RPI using the official installation guide on RPI.
         https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script
      2. Run and verify everything is working as expected.
         Note: press 't' key to issue voice command to Alexa.

B. Integrate AVS SDK modifications (AVS SDK 1.11.0, [12-19-2018])

      1. The RPI Alexa Gateway is a customized AVS SDK.
         Replace the original avs-device-sdk folder with this modified avs-device-sdk. 
      2. Install SOX utility
         sudo apt-get install sox libsox-fmt-mp3
      3. Compile and run.
         Note: You should see logs containing 'FT900'.
      4. Setup and run FT900.


### FT900 setup:

Download the latest [FT900 Alexa Client](https://github.com/richmondu/FT900/tree/master/Alexa/Amazon%20Alexa%20Client) code.

A. Test Mode (Use a pre-recorded request contained in SD card)

      1. Change AVS_CONFIG_SERVER_ADDR in avs_config.h.
         This should contain the IP address of the RPI
      2. Copy test/request.raw to SD card.
         request.raw is an audio recording of "What time is it?"
      3. Compile and run.
         This automatically sends the pre-recorded audio, request.raw, to RPI.

B. Normal Mode (User presses a key or button to trigger voice recording)

      1. Change AVS_CONFIG_SERVER_ADDR to avs_config.h.
         This should contain the IP address of the RPI
      2. Change TEST_MODE to 0 in main.
      3. (Optional) Change USE_GPIO to 1 in button.c.
         (Optional) Connect button to GPIO 31, 5V and GND.
         (Optional) Default is UART instead of GPIO.
      4. Compile and run.
      5. For UART mode, Press 't' to start recording voice command.
         For GPIO mode, press the button.
      6. For UART mode, press 't' again to stop recording voice command.
         For GPIO mode, release the button.
      7. After stopping the recording, FT900 will send the voice request to RPI.



# Action items

Below are the action items for the Alexa Demo.

      1. Support for wake-word detection in FT900. Currently, user has to press down a button to start voice recording.
      2. Use 8KHz instead of 16KHz in FT900 to further reduce audio transmitted size by half. (However, note that RPI will have to convert the 8KHz to 16KHz as Alexa cloud requires 16KHz).
      3. Performance/speed optimization
      4. Support for alarms or notification-based messages. (Currently, only responses triggered by requests are supported.)
      5. Support for very long Alexa responses. (Need to test requests that have very long responses.)
      6. Support for queuing Alexa requests from multiple FT900 clients. (Multiple FT900 can simultaneously send requests to RPI. RPI should queue the requests and only issue a request when a response for previous request is processed.)
      7. RPI should not play response on its speaker when the request is from FT900.
      8. Audio decoding implementation currently uses bash scripts using SOX utility. (Should be replaced with C/C++ code)
      9. Upgrade to latest AVS SDK version. Currently using AVS SDK 1.11.0, (12-19-2018). As of today, the latest version is AVS SDK 1.12.0 (02-28-2019).


# References

Below are the essential links to familiarize with Alexa and audio terminologies needed for FT900 Alexa Demo.
1. [Alexa Voice Service (AVS)](https://developer.amazon.com/alexa-voice-service)

      <a href="https://www.youtube.com/watch?v=oTaFX3ZQlnA"
       target="_blank"><img src="https://img.youtube.com/vi/oTaFX3ZQlnA/0.jpg" 
       alt="Alexa Voice Service" width="480" border="10" /></a>

2. [Getting Started with the AVS Device SDK](https://www.youtube.com/watch?v=F5DixCPJYo8&feature=youtu.be)

      <a href="https://www.youtube.com/watch?v=F5DixCPJYo8"
       target="_blank"><img src="https://img.youtube.com/vi/F5DixCPJYo8/0.jpg" 
       alt="Getting Started with the AVS Device SDK" width="480" border="10" /></a>
       
3. [Amazon's Official AVS Device SDK (written in C++)](https://github.com/alexa/avs-device-sdk)
4. [AVS SDK Installation Guide on Raspberry PI](https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script)
5. [SOX Sound Exchange Utility (used for MP3 audio decoding)](http://sox.sourceforge.net)
6. [G711 Audio Companding algorithms (used for u-law audio compression/expanding)](https://en.wikipedia.org/wiki/G.711)

