# FT900 Alexa Demo


This PoC application demonstrates using <b>FT900 microcontroller</b> (MCU) as an <b>Amazon Echo Dot</b> device, where users can issue voice commands to Alexa and hear Alexa’s voice responses generated by Alexa’s complex speech recognition and natural language processing in the cloud. To make <b>Alexa on MCU</b> possible, FT900 (Alexa client) communicates with a <b>Raspberry PI 3B+</b> (Alexa gateway), which relays voice requests and voice responses to and from the Alexa cloud. The RPI runs a customized version of Amazon’s official open-source <b>[Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk)</b>, written in C++.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/system_diagram.jpg" width="623"/>

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/alexa_steps.jpg" width="623"/>


This demo is targeted for <b>FTDI/Bridgetek’s</b> smart home devices, <b>PanL Hub</b> and <b>PanL Display</b>. Having <b>[Alexa built-in](https://developer.amazon.com/alexa-voice-service)</b> to <b>PanL Smart Home</b> allow customers to talk directly to Alexa via PanL without needing to buy Amazon Echo devices. Furthermore, customers will have access to the <b>built in capabilities of Alexa</b> (like music playback, timers and alarms, package tracking, movie listings, calendar management, and more) including access to third-party skills developed using the Alexa Skills Kit. 

PanL Hub, which runs on RPI, acts as the <b>Alexa Gateway</b> while the PanL Display, which runs on FT900 microcontroller, acts as the <b>Alexa Client</b>. Customers will be able to use both PanL Hub and PanL Display to issue voice commands and operations to Alexa.


# FT900-side (Alexa Client)

Below is a block diagram showing the implemented components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram.jpg" width="623"/>

      - SD Card should be replaced with SPI Flash or I2C EEPROM on PanL display.
      - RTC library is used to measure time elapsed for performance measurement.

Below is a sequence diagram showing the basic interaction of components of the FT900 application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram.jpg" width="623"/>


### FT900 Alexa AVS library

The main component of the Alexa Demo on the FT900 side is the Alexa AVS library. I created the library to be reusable (for PanL Display) and easy to use (abstract the audio, the SD card and the network communication). SD Card should be replaced with SPI Flash or I2C EEPROM. The main functions include:

      - avs_connect() - Establish connection with RPI
      - avs_record_request() - Record voice request from microphone and save to SD card
      - avs_send_request() - Read voice request from SD card and send to RPI
      - avs_receive_response() - Receive voice response from RPI and save to SD card
      - avs_play_response() - Play voice response from SD card
      - avs_recv_and_play_response() - Receive and play voice response from RPI without saving to SD card (faster performance)
      - avs_recv_and_play_response_threaded() - Receive and play voice response from RPI in separate threads using overlapping io. 
      - avs_disconnect() - Closes connection with RPI

### Wakeword Detection

The demo currently does not support Wakeword detection. To trigger FT900 to start recording voice, user has to press down a button. To stop recording, user has to release the button. This works similar to the remote control for Amazon's Firestick TV.

The demo provides two ways to trigger voice recording:

      - UART Mode: Press 't' key on UART terminal
      - GPIO Mode: Press hardware button connected to GPIO 31

To support Wakeword detection feature on FT900, external MCUs can be integrated as slave devices to handle wakeword detection. 
[SparkFun's board](https://petewarden.com/2019/03/07/launching-tensorflow-lite-for-microcontrollers/) is an example board that can be used for wakeword detection.


### Audio Processing 

Below is a description of how the audio is processed on FT900.

      avs_record_request()
      - Audio recorded (from mic): 16-bit PCM, 16KHZ, stereo (2-channels)
      - Audio saved (to SD card): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_send_request()
      - Audio read (from SD card): 16-bit PCM, 16KHZ, mono (1-channel)
      - Audio sent (to RPI): 8-bit u-law, 16KHZ, mono (1-channel)

      avs_recv_response()
      - Audio received (from RPI): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio saved (to SD card): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_play_response()
      - Audio read (from SD card): 16-bit PCM, 16KHZ, mono (1-channel)
      - Audio played (to speaker): 16-bit PCM, 16KHZ, stereo (2-channels)

      avs_recv_and_play_response()
      - Audio received (from RPI): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio played (to speaker): 16-bit PCM, 16KHZ, stereo (2-channels) 
      
      avs_recv_and_play_response_threaded()
      - Audio received (from RPI): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio played (to speaker): 16-bit PCM, 16KHZ, stereo (2-channels)  
      
      Notes
      - G711 u-law lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and                vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
      - Converting stereo data stream to mono data stream is done by averaging the consecutive left and right 16-bits WORDS.


### Test Mode

Using test mode, the application automatically sends pre-recorded requests (saved in SD card) to RPI Alexa Gateway every 10 seconds. 

      - It allows easy testing and troubleshooting of the demo.
      - It allows easy reproduction of issues. 


### Test Simulator

A Python script application named FT900 Alexa Simulator is provided to simulate the behavior of FT900.

      - It can be run on Windows and Linux machine.
      - It can assist in automated testing and stress testing of RPI Alexa Gateway.



# RPI-side (Alexa Gateway)

Amazon provides an official [Alexa Voice Service (AVS) SDK](https://github.com/alexa/avs-device-sdk), (written in C++). The version I am now using is version v1.12.0 AVS SDK. Instructions to install the AVS SDK on RPI can also be found on the github link.

Below is a system diagram of AVS SDK.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/system_diagram_avs.jpg" width="623"/>

Below is a block diagram showing the implemented components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/block_diagram_rpi.jpg" width="623"/>

Below is a sequence diagram showing the basic interaction of components of the RPI application.
<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/sequence_diagram_rpi.jpg" width="623"/>

      1. A ConnectionHandler thread is initialized in the main function of the AVS SDK SampleApplication.
      2. The ConnectionHandler thread waits for an FT900 connection.
      3. Once an FT900 connected, it initializes two threads, FT900RequestHandler and FT900ResponseHandler.
      4. FT900RequestHandler handles the processing of Alexa requests from FT900.
      5. FT900ResponseHandler handles the processing of Alexa responses to FT900.
      6. Only 1 FT900 can connect at a time.
      7. FT900RequestHandler receives Alexa request (8-bit compressed using ulaw algorithm) from FT900.
      8. FT900RequestHandler decompresses/expands the Alexa request from 8-bit to 16-bit.
      9. FT900RequestHandler copies the data stream to the microphone input data buffer in PortAudioMicrophoneWrapper.
      10. The Alexa request is then sent to the cloud and receives the Alexa response which is in MP3 format.
      11. SpeechSynthesizer copies the data stream to an MP3 file.
      12. SpeechSynthesizer converts the Alexa response from MP3 format to raw PCM format in a separate thread.
      13. SpeechSynthesizer does not play the response since the request is from FT900.
      14. FT900RequestHandler compresses the Alexa response to 8-bit from 16-bit.
      15. FT900RequestHandler sends the Alexa response (8-bit compressed using ulaw algorithm) to FT900.
      16. The ConnectionHandler thread waits until FT900RequestHandler and FT90ResponseHandler terminates.
      17. The ConnectionHandler thread closes the socket once FT900RequestHandler and FT900ResponseHandler threads terminate. 


### Alexa Capabilities

AVS SDK supports 3 major capabilities: 

      1. SpeechSynthesizer for dialog/speech/user-interaction directives
      2. Alerts for timer directives
      3. AudioPlayer for content/music/play directives

Currently, only SpeechSynthesizer audio data stream is hooked. 
To support AudioPlayer and AlertsTimer, more modifications will be necessary, including persistent connection, MPEG decoding, etc. 


### RPI Alexa AVS SDK modifications

In addition to the new modules implemented described in the block diagram and sequence diagram, 
the primary modifications for the AVS SDK application are contained in PortAudioMicrophoneWrapper class and SpeechSynthesizer classes.
 
      - PortAudioMicrophoneWrapper: PortAudioCallback() contains the data stream for Alexa request
      - SpeechSynthesizer: startPlaying() contains the data stream for Alexa response

Below is a list of files modified:

      - SampleApplication.cpp: To initialize FT900ConnectionHandler in separate thread.
      - PortAudioMicrophoneWrapper.cpp: To feed in request data to microphone datastream.
      - SpeechSynthesizer.cpp: To call the callback function when response is received.
      - MediaPlayer.cpp: To fix audiosink issue.
      - DefaultClient.h: To provide access to Speech Synthesizer handle.
      - UIManager.h: To access connection status and dialog state.
      - UserInputManager.cpp: To test pre-recorded audio requests.

Below is a list of files created:

      - FT900ConnectionHandler.cpp
      - FT900RequestHandler.cpp
      - FT900RequestHook.cpp
      - FT900ResponseHandler.cpp
      - FT900ResponseHook.cpp
      - FT900AudioCompression.cpp
      - FT900AudioCompressionHelper.cpp
      - FT900AudioDecoding.cpp
      - FT900AudioRateConversion.cpp

All of new files starts with FT900 to easily distinguish it from original AVS SDK files. 

After modifications, the total size of the binary executable is 16.2MB.


### Audio Processing 

Below is a description of how the audio is processed on RPI.

      avs_request()
      - Audio received (from FT900): 8-bit u-law, 16KHZ, mono (1-channel)
      - Audio sent (to Alexa cloud): 16-bit PCM, 16KHZ, mono (1-channel)

      avs_response()
      - Audio received (from Alexa cloud): MP3
      - Audio sent (to FT900): 8-bit u-law, 16KHZ, mono (1-channel)

      Notes
      - G711 u-law lossless companding (compression/expanding) algorithm is used to convert data stream from 16-bit to 8-bit and vice versa. Compressing the data before transmission reduces the data bandwidth usage by half.
      - SOX utility is used to convert MP3 data stream to raw PCM16 data stream.


# Performance analysis/optimization

### A. Optimization efforts

Below are the major performance optimization efforts implemented for the demo.

      1. 8-bit ulaw audio compression
      - audio is compressed from 16-bit to 8-bit using G711 ulaw lossless algorithm before transmitting to FT900 or RPI.

      2. 16khz audio sampling rate
      - sample i2s master applications only support 44.1khz and 48khz. size of 48khz is 3 times as much as 16khz.

      3. receive and play Alexa response without saving to SD card
      - this improved FT900-RPI-AVS-RPI-FT900 round trip from 6-7 seconds to 4 seconds.
      - audio quality did not degrade because FIFO size of i2s master is maximized
      
      4. disable playback of response on RPI when request is from FT900
      - RPI should only play response when the request is from RPI microphone.


### B. RPI

One round trip of Alexa request and Alexa response on the RPI side (RPI-AVS-RPI) is about 3.2 seconds (now optimized to 2.6 seconds).
This is for a simple command, "What time is it?". 
This measures the time RPI accepts FT900 connection until it closes the connection.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/rpi_logs.png" width="623"/>

Note that the logs correspond to the sequence diagram above.


### C. FT900

One round trip of Alexa request and Alexa response on the FT900 side (FT900-RPI-AVS-RPI-FT900) is 5-6 seconds.
This has been optimized from 6-7 seconds.
This measurement is for a simple command, "What time is it?". 
This measures the time FT900 sends the Alexa request to RPI until it finishes playing Alexa response.
It takes 4.0 seconds to wait and receive the Alexa response. On RPI side, this is 3.2 seconds so it means FT900 consumes 0.8 second processing overhead.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/ft900_logs.png" width="623"/>

Since the delay is in the processing of Alexa response, one alternative solution is to play the audio stream directly to the speaker without saving it to the SD card. By doing this, performance on the FT900 side (FT900-RPI-AVS-RPI-FT900) has been optimized to 4-5 seconds. This is a major performance improvement. And audio quality is actually very good. Audio quality did not degrade or cause jittering.

<img src="https://github.com/richmondu/FT900/blob/master/Alexa/Amazon%20Alexa%20Client/docs/images/ft900_logs2.png" width="623"/>

Below are the three modes supported for processing Alexa responses.

      1. recv and play by completely saving response to sd card before playing
      - good. (performance 7seconds)
      #define USE_RECVPLAY_RESPONSE 0

      2. recv and play directly without saving to SD card
      - good and faster. default (performance 4seconds)
      #define USE_RECVPLAY_RESPONSE 1

      3. recv and play in separate threads
      - new; not so good (performance 5-6seconds)
      #define USE_RECVPLAYTHREADED_RESPONSE 1


# Audio quality analysis

### A. FT900 Speaker playback

Playback of Alexa response on connected speaker is very very good. There is no noise or jittering. It is very smooth.

This was made possible by maximizing the FIFO buffer sizes for both SD Host (4KB) and I2S Master (2KB).
4KB data is read from SD card then segmented into 4 1KBs. 
Each 1KB data is converted from mono (1-channel) to stereo (2-channels).
This results to 2KB stereo data which is then written to I2S Master speaker. 
The process is repeated until the recorded audio file is completely processed.

When streaming the Alexa response directly to the speaker without saving to SD card,
512 bytes is received from RPI, then expanded from 8-bit to 16-bit (1KB), then converted mono to stereo (2KB).
This is an efficient transfer because I2S Master FIFO size is only 2KB.


### B. FT900 Microphone recording

Recording of Alexa request on FT900 microphone is good. Background noise can be heard but voice pops out when user speaks very near to microphone.



# PanL Smart Home Adoption analysis

### A. RS485 small bandwidth issue

The demo currently uses Ethernet for communication between RPI and FT900. 
For PanL, where communication medium is RS485, bandwidth is smaller, about 92KBps only. 
This is one of the major concerns for adoption of the solution to PanL Smart Home Solution.
Below is an analysis that answers this concern.

The size of an 8-bit 16khz response for a simple question "What time is it?" is less than 32kb. This is sent in 2ms.
30720bytes *1000/2ms=15360000 (14.6 MBps)

To simulate RS485 slowness, I added delay between each send (note that 32kb is sent in chunks as it is compressed in chunks).
Results:

      1) 20ms delay => response is sent in about 1sec instead of 2ms. (32k bytes/sec) *causes stutter
      2) 13ms delay => response is sent in about 660ms instead of 2ms. (48k bytes/sec)
      3) 10ms delay => response is sent in about 500ms instead of 2ms. (64k bytes/sec)
      4)  6ms delay => response is sent in about 330ms instead of 2ms. (96k bytes/sec)

The 20ms added delay sometimes causes a stutter for recv_and_play_no_sdcard option as sender becomes slow.
Meaning, using SD card to save response is necessary when sender rate is around 32KBps only.

But since the acceptable computed rate for RS485 is 64KBps (70% of 92KBps), then not using SD card to save response is still OK.
If we use SD card to save response, then RS485 is not a even problem. 

Note that the demo solution provides both options to save or not to save response to SD card. 
(Saving response to SD card is 1-2 seconds slower than NOT saving response to SD card.)


### B. CPU usage issue

Another concern is the CPU usage consumed by the application on RPI. 

Based on observation, the CPU usage jumps to 20-30% for a split second when processing a request. This is OK. 
Note that no AI is done on the RPI. 
The Alexa SDK only forwards the request on the cloud where the AI-generated response is created. 
So the Alexa application on RPI does NOT and can NOT hog the CPU.   



# Setup guide

### Prerequisites:

A. RPI

      1. RPI 3B+ 
      2. Headphone or speaker
      3. USB microphone https://circuit.rocks/usb-mini-microphone.html

B. FT900

      1. FT900 Rev C board (mm900ev1b)
      2. SD card (class-6 or 10, ush-1, <= 32gb) https://www.lazada.com.ph/-i7948043-s10125616.html?urlFlag=true&mp=1
      3. Headphone or speaker
      4. (Optional) Button https://circuit.rocks/button-digital (for GPIO mode)

Note you can issue voice commands to either RPI or FT900.


### RPI setup:

Download the latest [RPI Alexa Gateway](https://github.com/richmondu/FT900/tree/master/Alexa/Amazon%20Alexa%20Gateway) code.
         
A. Install AVS SDK (latest version is AVS SDK 1.12.0 [02-28-2019])

      1. Install the original AVS SDK on RPI using the official installation guide on RPI.
         https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script
      2. Run and verify everything is working as expected.
         Note: Say 'Alexa' to trigger voice recording. Alternatively, press 't' key followed by Enter key to trigger recording.
         First run requires authorization. Go to https://amazon.com/us/code and type the code displayed in  the logs.
         
B. Integrate AVS SDK modifications (supports AVS SDK 1.12.0 [02-28-2019])

      1. The RPI Alexa Gateway is a customized AVS SDK.
         Replace the original avs-device-sdk folder with this modified avs-device-sdk. 
      2. Install SOX utility
         sudo apt-get install sox libsox-fmt-mp3 libsox-dev
      3. Compile and run.
         cd /home/..../alexa/build/SampleApp/src
         sudo ./SampleApp "/home/.../alexa/build/Integration/AlexaClientSDKConfig.json" "/home/.../alexa/third-party/alexa-rpi/models" INFO
         Note: You should see logs containing 'FT900'.
         Note: Verify everything is working as expected.
         Note: Say 'Alexa' to trigger voice recording. Alternatively, press 't' key followed by Enter key to trigger recording.
         Note: RPI application will fail if microphone is removed. So don't remove it.
      4. Setup and run FT900.


### FT900 setup:

Download the latest [FT900 Alexa Client](https://github.com/richmondu/FT900/tree/master/Alexa/Amazon%20Alexa%20Client) code.

A. Test Mode (Use a pre-recorded request contained in SD card)

      1. Change AVS_CONFIG_SERVER_ADDR in avs_config.h.
         This should contain the IP address of the RPI
      2. Copy test/request.raw to SD card.
         request.raw is an audio recording of "What time is it?"
      3. Compile and run.
         This automatically sends the pre-recorded audio, request.raw, to RPI.

B. Normal Mode (User presses a key or button to trigger voice recording)

      1. Change AVS_CONFIG_SERVER_ADDR to avs_config.h.
         This should contain the IP address of the RPI
      2. Change TEST_MODE to 0 in main.
      3. (Optional) Change USE_GPIO to 1 in button.c.
         (Optional) Connect button to GPIO 31, 5V and GND.
         (Optional) Default is UART instead of GPIO.
      4. Compile and run.
      5. For UART mode, Press 't' to start recording voice command.
         For GPIO mode, press the button.
      6. For UART mode, press 't' again to stop recording voice command.
         For GPIO mode, release the button.
      7. After stopping the recording, FT900 will send the voice request to RPI.



# Action items

Below are the action items for the Alexa Demo.

      1. Support for wake-word detection in FT900. Currently, user has to press down a button to start voice recording.
      2. Use 8KHz instead of 16KHz in FT900 to further reduce audio transmitted size by half. (However, note that RPI will have to convert the 8KHz to 16KHz as Alexa cloud requires 16KHz).
      3. Support for alarms or notification-based messages. (Currently, only responses triggered by requests are supported.)
      4. Support for very long Alexa responses. (Need to test requests that have very long responses.)
      5. Support for queuing Alexa requests from multiple FT900 clients. (Multiple FT900 can simultaneously send requests to RPI. RPI should queue the requests and only issue a request when a response for previous request is processed.)
      6. Audio decoding implementation currently uses bash scripts using SOX utility. (Should be replaced with C/C++ code)



# References

Below are the essential links to familiarize with Alexa and audio terminologies needed for FT900 Alexa Demo.
1. [Alexa Voice Service (AVS)](https://developer.amazon.com/alexa-voice-service)

      <a href="https://www.youtube.com/watch?v=oTaFX3ZQlnA"
       target="_blank"><img src="https://img.youtube.com/vi/oTaFX3ZQlnA/0.jpg" 
       alt="Alexa Voice Service" width="480" border="10" /></a>

2. [Getting Started with the AVS Device SDK](https://www.youtube.com/watch?v=F5DixCPJYo8&feature=youtu.be)

      <a href="https://www.youtube.com/watch?v=F5DixCPJYo8"
       target="_blank"><img src="https://img.youtube.com/vi/F5DixCPJYo8/0.jpg" 
       alt="Getting Started with the AVS Device SDK" width="480" border="10" /></a>
       
3. [Amazon's Official AVS Device SDK (written in C++)](https://github.com/alexa/avs-device-sdk)
4. [AVS SDK Installation Guide on Raspberry PI](https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script)
5. [SOX Sound Exchange Utility (used for MP3 audio decoding)](http://sox.sourceforge.net)
6. [G711 Audio Companding algorithms (used for u-law audio compression/expanding)](https://en.wikipedia.org/wiki/G.711)

